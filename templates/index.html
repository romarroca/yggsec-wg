{% extends "base.html" %}
{% block title %}YggSec · WireGuard Settings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  .section-title { margin-bottom:.5rem; }
  .form-control, .form-select{
    border: 1.5px solid var(--btn-border);
    background: var(--btn-bg);
    color: var(--ink);
    border-radius: 8px;
  }
  .form-control:focus, .form-select:focus{
    border-color: var(--btn-border);
    box-shadow: 0 0 0 .15rem rgba(0,0,0,.08);
    color: var(--ink);
    background: var(--btn-hover-bg);
  }
  body.theme-dark .form-control::placeholder{ color:#9aa7b3; opacity:1; }
  .btn-icon{
    border:1.5px solid var(--btn-border);
    background:var(--btn-bg);
    color:var(--ink);
    border-radius:8px;
    padding:.35rem .55rem; line-height:1;
  }
  .btn-icon:hover{ background:var(--btn-hover-bg); }
  #remote-sites-table th { vertical-align: middle; }

  
  .cu-muted{ color:var(--ink); opacity:.7; }
</style>

<script src="{{ url_for('static', filename='js/qrcode.min.js') }}"></script>
{% endblock %}

{% block content %}
  <h2 class="mb-4 section-title">WireGuard Settings</h2>

  <!-- Hub Info -->
  <div class="card shadow-sm position-relative mb-4">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      Hub Info
      <div class="dropdown">
        <button class="btn btn-sm btn-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-title="Quick actions" data-bs-toggle="tooltip">
          <i class="bi bi-gear"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <form method="POST" action="{{ url_for('regenerate') }}" style="margin:0;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="dropdown-item">Save Current Config</button>
            </form>
          </li>
          <li><a class="dropdown-item" href="{{ url_for('restart') }}">Restart wg0</a></li>
          <li>
            <form method="POST" action="{{ url_for('regen_hub_keys') }}" style="margin:0;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="dropdown-item">Regenerate Hub Keys</button>
            </form>
          </li>
        </ul>
      </div>
    </div>
    <div class="card-body">
      {% if topology and topology.hub %}
        <div class="d-flex align-items-center flex-wrap gap-2">
          <p class="mb-0"><strong>Public IP:</strong> {{ topology.hub.public_ip }}</p>
          <button class="btn btn-sm btn-icon ms-1" data-bs-toggle="modal" data-bs-target="#editPublicIpModal" data-bs-toggle="tooltip" data-bs-title="Edit public IP/FQDN">
            <i class="bi bi-pencil"></i>
          </button>
        </div>
        {% if topology.hub.interface %}
          <div class="d-flex align-items-center flex-wrap gap-2">
            <p class="mb-0"><strong>WireGuard Interface:</strong> 
              <span class="badge bg-info">{{ topology.hub.interface }}</span>
              {% if topology.hub.interface != "auto-detected" %}
                <small class="text-muted">- listening UDP {{ topology.hub.wg_port or 51820 }}</small>
              {% else %}
                <small class="text-muted">- Listening on all interfaces, UDP {{ topology.hub.wg_port or 51820 }}</small>
              {% endif %}
            </p>
            <button class="btn btn-sm btn-icon ms-1" data-bs-toggle="modal" data-bs-target="#editWgPortModal" data-bs-toggle="tooltip" data-bs-title="Edit WireGuard port">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        {% endif %}
        <div class="d-flex align-items-center flex-wrap gap-2">
          <p class="mb-0"><strong>VPN Subnet:</strong> {{ topology.hub.subnet }}</p>
          <button class="btn btn-sm btn-icon ms-1" data-bs-toggle="modal" data-bs-target="#editSubnetModal" data-bs-toggle="tooltip" data-bs-title="Edit VPN subnet">
            <i class="bi bi-pencil"></i>
          </button>
        </div>
        <div class="d-flex align-items-start flex-wrap gap-2">
          <p class="mb-0"><strong>Hub LANs:</strong></p>
          <div class="flex-fill">
            {% if topology.hub.lan_subnets %}
              {% for lan in topology.hub.lan_subnets %}
                <span class="badge bg-secondary me-2 mb-1">
                  {{ lan }}
                  <button type="button" class="btn-close btn-close-white ms-2" 
                          data-bs-toggle="modal" data-bs-target="#removeLanModal" 
                          data-lan-subnet="{{ lan }}" 
                          data-bs-toggle="tooltip" data-bs-title="Remove this LAN subnet"
                          style="font-size: 0.7em;"></button>
                </span>
              {% endfor %}
            {% else %}
              <span class="text-muted">None configured</span>
            {% endif %}
            <button class="btn btn-sm btn-icon ms-1" data-bs-toggle="modal" data-bs-target="#addLanModal" data-bs-toggle="tooltip" data-bs-title="Add a local LAN subnet">Add LAN</button>
          </div>
        </div>
      {% else %}
        <p class="text-muted mb-0">No hub information available.</p>
      {% endif %}
    </div>
  </div>

  <!-- Remote Sites -->
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold d-flex align-items-center justify-content-between">
      <span>Remote Sites</span>
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSpokeModal" data-bs-toggle="tooltip" data-bs-title="Add a new remote site">Add New</button>
    </div>
    <div class="card-body">
      <table id="remote-sites-table" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>VPN IP</th>
            <th>LAN Subnet</th>
            <th class="text-center">Actions</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% set peers_safe = peers|default([], true) %}
          {% if topology and topology.spokes %}
            {% for s in topology.spokes %}
              {% set peer = (peers_safe | selectattr('vpn_ip','equalto', s.vpn_ip|default('')) | list | first) %}
              <tr data-vpn-ip="{{ s.vpn_ip|default('') }}">
                <td class="fw-bold">{{ s.name }}</td>
                <td>{{ s.vpn_ip }}</td>
                <td>{{ s.lan_subnet }}</td>
                <td class="text-center">
                  <div class="d-flex justify-content-center gap-1">
                    <a class="btn btn-icon" href="{{ url_for('download_spoke', name=s.name) }}" data-bs-toggle="tooltip" data-bs-title="Download config"><i class="bi bi-download"></i></a>
                    <form method="POST" action="{{ url_for('regen_spoke_keys', name=s.name) }}" style="display:contents;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="btn btn-icon" data-bs-toggle="tooltip" data-bs-title="Regenerate keys"><i class="bi bi-arrow-clockwise"></i></button>
                    </form>
                    <button type="button" class="btn btn-icon btn-qrcode" data-name="{{ s.name }}" data-bs-toggle="tooltip" data-bs-title="Show QR"><i class="bi bi-qr-code"></i></button>
                    <button type="button" class="btn btn-icon btn-ping" data-name="{{ s.name }}" data-bs-toggle="tooltip" data-bs-title="Test connectivity"><i class="bi bi-exclamation-circle"></i></button>
                    <button type="button" class="btn btn-icon btn-delete" data-name="{{ s.name }}" data-url="{{ url_for('delete_spoke', name=s.name) }}" data-bs-toggle="tooltip" data-bs-title="Delete"><i class="bi bi-trash"></i></button>
                  </div>
                </td>
                <td class="status-cell">
                  <div class="ping-status" id="ping-{{ s.name }}">
                    <span class="badge bg-secondary">Unknown</span>
                    <div class="ping-details" style="display: none;">
                      <small class="text-muted ping-time"></small>
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-center text-muted">No remote sites added yet</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit VPN Subnet -->
  <div class="modal fade" id="editSubnetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/edit-vpn-subnet" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-header">
          <h5 class="modal-title">Edit VPN Subnet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">VPN Subnet (CIDR)</label>
            <input type="text" class="form-control" name="vpn_subnet" 
                   value="{{ topology.hub.subnet if topology and topology.hub else '' }}" 
                   placeholder="e.g. 10.250.250.0/24" required>
            <div class="form-text">⚠️ Changing this will require reconfiguring all clients</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update VPN Subnet</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Public IP -->
  <div class="modal fade" id="editPublicIpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/edit-public-ip" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-header">
          <h5 class="modal-title">Edit Public IP/FQDN</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Public IP or Domain Name</label>
            <input type="text" class="form-control" name="public_ip" 
                   value="{{ topology.hub.public_ip if topology and topology.hub else '' }}" 
                   placeholder="e.g. 203.0.113.15 or vpn.example.com" required>
            <div class="form-text">⚠️ Changing this will require reconfiguring all clients</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update Public IP</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Remove Hub LAN -->
  <div class="modal fade" id="removeLanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/remove-hub-lan" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="lan_subnet" id="removeLanSubnet">
        <div class="modal-header">
          <h5 class="modal-title">Remove Hub LAN Subnet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to remove this LAN subnet?</p>
          <p><strong id="removeLanDisplay"></strong></p>
          <p class="text-muted small">This will update the hub configuration and regenerate WireGuard configs.</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Remove LAN Subnet</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit WireGuard Port -->
  <div class="modal fade" id="editWgPortModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/edit-wg-port" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-header">
          <h5 class="modal-title">Edit WireGuard Port</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">WireGuard Port (UDP)</label>
            <input type="number" class="form-control" name="wg_port" 
                   value="{{ topology.hub.wg_port or 51820 if topology and topology.hub else 51820 }}" 
                   min="1024" max="65535" placeholder="e.g. 51820" required>
            <div class="form-text">⚠️ Changing this will require reconfiguring all clients. Port range: 1024-65535</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update WireGuard Port</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Hub LAN -->
  <div class="modal fade" id="addLanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/add-hub-lan" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-header">
          <h5 class="modal-title">Add Hub LAN Subnet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">LAN Subnet(s)</label>
            <input type="text" class="form-control" name="lan_subnets" placeholder="e.g. 192.168.100.0/24,192.168.200.0/24" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Hub LAN</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Spoke -->
  <div class="modal fade" id="addSpokeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/add-spoke" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-header">
          <h5 class="modal-title">Add Remote Site</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Spoke Name</label>
            <input type="text" class="form-control" name="name" placeholder="e.g. site1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">LAN Subnet <small class="text-muted">(optional)</small></label>
            <input type="text" class="form-control" name="lan_subnet" placeholder="e.g. 192.168.50.0/24">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Spoke</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Confirm Delete -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="deleteForm" method="post" class="modal-content">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="modal-header">
          <h5 class="modal-title">Delete <span id="delName" class="fw-bold"></span>?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">This will remove the spoke and its config files. This action cannot be undone.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QR Modal (with white frame) -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">QR Code · <span id="qrTitle" class="fw-bold"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="qr-wrap">
            <div class="qr-frame">
              <canvas id="qrCanvas"></canvas>
              <div id="qrBox"></div>
            </div>
          </div>
          <p id="qrError" class="text-danger small mt-3 mb-0" style="display:none;"></p>
          <p id="qrHint" class="mt-3 mb-0 cu-muted" style="font-size:.9rem;">Scan with WireGuard to import this peer configuration.</p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script nonce="{{ g.nonce }}">
  // Load and display persisted ping results on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadPersistedPingResults();
  });

  function loadPersistedPingResults() {
    fetch('/api/ping-results')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.results) {
          Object.entries(data.results).forEach(([spokeName, result]) => {
            updatePingDisplay(spokeName, result);
          });
        }
      })
      .catch(error => {
        console.log('Could not load persisted ping results:', error);
      });
  }

  function updatePingDisplay(spokeName, result) {
    const pingStatusDiv = document.getElementById(`ping-${spokeName}`);
    if (!pingStatusDiv) return;

    const badgeElement = pingStatusDiv.querySelector('.badge');
    const detailsDiv = pingStatusDiv.querySelector('.ping-details');
    const timeElement = pingStatusDiv.querySelector('.ping-time');

    if (!badgeElement || !detailsDiv || !timeElement) return;

    // Format timestamp
    const timestamp = new Date(result.timestamp * 1000);
    const timeStr = timestamp.toLocaleString();

    if (result.reachable) {
      const responseTime = result.response_time ? `${result.response_time}ms` : 'OK';
      badgeElement.className = 'badge bg-success';
      badgeElement.innerHTML = `✓ ${responseTime}`;
      timeElement.innerHTML = `Last tested: ${timeStr}`;
    } else {
      badgeElement.className = 'badge bg-warning';
      badgeElement.innerHTML = '⚠ Unreachable';
      timeElement.innerHTML = `Offline or blocking ping - ${timeStr}`;
    }

    // Show details
    detailsDiv.style.display = 'block';
  }

  // Confirm delete
  (function () {
    const modalEl = document.getElementById('confirmDeleteModal');
    const delNameEl = document.getElementById('delName');
    const formEl = document.getElementById('deleteForm');
    const modal = new bootstrap.Modal(modalEl);

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.btn-delete');
      if (!btn) return;
      delNameEl.textContent = btn.getAttribute('data-name') || '';
      formEl.setAttribute('action', btn.getAttribute('data-url') || '#');
      modal.show();
    });
  })();

  // Secure peer ping functionality
  (function() {
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn-ping');
      if (!btn) return;
      
      e.preventDefault();
      const spokeName = btn.getAttribute('data-name');
      if (!spokeName) return;
      
      pingPeer(spokeName, btn);
    });
    
    function pingPeer(spokeName, buttonElement) {
      // Disable button during request
      const originalContent = buttonElement.innerHTML;
      buttonElement.disabled = true;
      buttonElement.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Testing...';
      
      // Get CSRF token
      const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                       document.querySelector('input[name=csrf_token]')?.value;
      
      // Get status elements
      const pingStatusDiv = document.getElementById(`ping-${spokeName}`);
      const badgeElement = pingStatusDiv.querySelector('.badge');
      const detailsDiv = pingStatusDiv.querySelector('.ping-details');
      const timeElement = pingStatusDiv.querySelector('.ping-time');
      
      // Show testing status
      badgeElement.className = 'badge bg-info';
      badgeElement.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Testing...';
      
      fetch('/api/ping-peer', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          'spoke_name': spokeName
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Use the shared update function for consistency
          updatePingDisplay(spokeName, data);
        } else {
          // Show error
          badgeElement.className = 'badge bg-danger';
          badgeElement.innerHTML = '✗ Error';
          timeElement.innerHTML = data.error || 'Test failed';
          detailsDiv.style.display = 'block';
        }
      })
      .catch(error => {
        // Show network error
        badgeElement.className = 'badge bg-danger';
        badgeElement.innerHTML = '✗ Network Error';
        timeElement.innerHTML = 'Request failed';
        detailsDiv.style.display = 'block';
      })
      .finally(() => {
        // Re-enable button
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalContent;
      });
    }
  })();
</script>

<!-- Load external QR functionality -->
<script nonce="{{ g.nonce }}" src="{{ url_for('static', filename='js/qr-functionality.js') }}"></script>

<script nonce="{{ g.nonce }}">
  // Handle remove LAN modal population
  document.addEventListener('DOMContentLoaded', () => {
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn-close[data-lan-subnet]');
      if (!btn) return;
      
      const lanSubnet = btn.getAttribute('data-lan-subnet');
      if (lanSubnet) {
        document.getElementById('removeLanSubnet').value = lanSubnet;
        document.getElementById('removeLanDisplay').textContent = lanSubnet;
      }
    });
  });
</script>
{% endblock %}

